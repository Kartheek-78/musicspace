<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VibeSpace - Room {{code}}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Borel&family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        margin: 0;
        padding: 40px 20px;
        text-align: center;
        min-height: 100vh;
        color: #fff;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 24 24' fill='%2399a4b2' opacity='0.75'%3E%3Cpath d='M18 3v13.09a4 4 0 1 1-2-3.46V7h-7V3h9z'/%3E%3C/svg%3E")
            repeat,
          linear-gradient(
            45deg,
            #0d6efd,
            #07b686,
            #ffe600,
            #ff00aa,
            #ae00ff,
            #00c6ff,
            #fd7f00,
            #ffea00,
            #00d977,
            #ff0080,
            #be1fcb,
            #19c4ff,
            #ffe133,
            #06d6a0,
            #ff4d4d,
            #5932f3,
            #0d6efd
          );
        background-size: auto, 2000% 2000%;
        animation: gradientLoop 18s linear infinite;
      }

      @media (max-width: 768px) {
        body {
          animation: gradientLoop 8s linear infinite;
        }
      }

      @keyframes gradientLoop {
        0% {
          background-position: 0% 50%;
        }
        100% {
          background-position: 100% 50%;
        }
      }

      .grid-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        max-width: 900px;
        margin: auto;
      }
      @media (min-width: 768px) {
        .grid-container {
          gap: 100px;
        }
      }

      .card-container {
        background: #d7cbcb;
        padding: 35px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      }

      /* YouTube input + buttons */
      .youtube-container input {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 35px;
        border: none;
        font-size: 1rem;
      }

      /* Buttons wrapper for desktop side-by-side */
      .btn-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      @media (min-width: 768px) {
        .btn-group {
          flex-direction: row;
          gap: 15px;
        }
      }

      .youtube-container button {
        flex: 1;
        padding: 10px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, background 0.2s;
      }
      .youtube-container button:hover {
        transform: translateY(-2px);
      }
      .btn-play {
        background: #07b686;
        color: #fff;
        border: none;
      }
      .btn-play:hover {
        background: #05976e;
      }
      .btn-leave {
        background: #dc3545;
        color: #fff;
        border: none;
      }
      .btn-leave:hover {
        background: #a71d2a;
      }

      /* Audio player */
      .audio-container audio {
        width: 100%;
        border-radius: 10px;
      }

      /* Users list */
      .users-container ul {
        list-style: none;
        padding-left: 0;
        max-height: 200px;
        overflow-y: auto;
        background: rgba(152, 152, 152, 0.5);
        border-radius: 10px;
        padding: 10px;
        color: black;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .users-container li {
        padding: 6px 0;
        color: black;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .users-container li:last-child {
        border-bottom: none;
      }

      #tapOverlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000000aa;
        color: #fff;
        z-index: 9999;
        font-size: 1.2rem;
        text-align: center;
        padding: 20px;
        border-radius: 12px;
      }

      /* Fixed alert container */
      #fixed-alert {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        pointer-events: none; /* prevents clicks blocking */
      }

      /* Alert box */
      #fixed-alert .alert {
        padding: 12px 25px;
        border-radius: 10px;
        font-weight: 600;
        text-align: center;
        min-width: 200px;
        background: rgba(0, 123, 255, 0.85);
        color: #fff;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transform: translateX(-100%);
        animation-fill-mode: forwards;
      }

      /* Slide in from left for joined/rejoined */
      @keyframes slideInLeft {
        0% {
          transform: translateX(-100%);
          opacity: 0;
        }
        100% {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Slide out to right for left */
      @keyframes slideOutRight {
        0% {
          transform: translateX(0);
          opacity: 1;
        }
        100% {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @media (min-width: 768px) {
        .grid-container {
          grid-template-columns: 2fr 1fr;
        }
        .audio-container {
          grid-column: 1 / span 2;
        }
      }

      @media (max-width: 767px) {
        .youtube-container {
          grid-row: 1;
        }
        .audio-container {
          grid-row: 2;
        }
        .users-container {
          grid-row: 3;
        }
        #tapOverlay {
          font-size: 1rem;
          padding: 15px;
        }
      }
      .site-footer {
        display: inline-block;
        text-align: center;
        font-size: 0.85rem;
        color: #e8e7e7;
        padding: 15px 10px;
        margin: 30px auto 0 auto;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-weight: 500;
        letter-spacing: 0.5px;
        background: rgba(94, 94, 94, 0.7);
        border-radius: 8px;
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .creator-name {
        font-family: "Borel", cursive;
        font-weight: 900;
        color: #ffea00;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      }

      .creator-name:hover {
        text-shadow: 0 2px 10px rgba(255, 230, 0, 0.7);
        transform: scale(1.05);
      }

      .room-header {
        font-family: "Poppins", sans-serif;
        font-weight: 700;
        font-size: 1.5rem;
        color: #ffffff;
        text-align: center;
        background: black;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        margin-bottom: 20px;
      }

      @media (min-width: 768px) {
        .room-header {
          margin-bottom: 70px;
        }
      }

      .room-code {
        font-weight: 900;
        font-size: 1.6rem;
        color: #ffe600 !important; /* accent color for the code */
      }
    </style>
  </head>
  <body>
    <h4 class="room-header">
      Room Code: <span class="room-code">{{code}}</span>
    </h4>

    <div id="fixed-alert"></div>

    <div class="grid-container">
      <!-- YouTube input + buttons -->
      <div class="card-container youtube-container">
        <input id="yt" placeholder="Paste YouTube Link" />
        <div class="btn-group">
          <button class="btn-play" id="playBtn">Play for All</button>
          <button class="btn-leave" id="leaveBtn">Leave Space</button>
        </div>
      </div>

      <!-- Users list -->
      <div class="card-container users-container">
        <h6 style="color: black">Users in Room:</h6>
        <ul id="users"></ul>
      </div>

      <!-- Audio player full-width -->
      <div class="card-container audio-container">
        <audio id="audio" controls></audio>
      </div>
    </div>

    <div id="tapOverlay">Tap anywhere to start playback</div>

    <footer class="site-footer">
      Made by <span class="creator-name">Kartheek</span>
    </footer>


 <script>
  const room = "{{code}}";
  const name = "{{name}}";
  const socket = io({
  transports: ["websocket"], // force websocket
  upgrade: false
});

  const audio = document.getElementById("audio");

  let isSyncing = false;
  let justJoined = true;

  // ---- Unlock playback on first user interaction ----
  document.body.addEventListener(
    "click",
    () => {
      document.getElementById("tapOverlay").style.display = "none";
      justJoined = false;
      socket.emit("get_current", { room: room });
    },
    { once: true }
  );

  // ---- Join room ----
  socket.emit("join", { room: room, name: name });

 // ---- Play button ---- 
   /*
document.getElementById("playBtn").onclick = () => {
  let url = document.getElementById("yt").value;

  // Play for myself (sender)
  isSyncing = true;
  audio.src = url;
  audio.play().catch(() => {});
  setTimeout(() => { isSyncing = false; }, 300);

  // Tell the server so others can play
  socket.emit("play", { room: room, url: url });
};
*/

   document.getElementById("playBtn").onclick = () => {
  let url = document.getElementById("yt").value;
  const playBtn = document.getElementById("playBtn");

  // ðŸš¨ Validation: Empty input
  if (!url) {
    alert("Please enter a YouTube link.");
    return;
  }

  // ðŸš¨ Validation: Must be a YouTube link
  const ytPattern = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+$/;
  if (!ytPattern.test(url)) {
    alert("Please enter a valid YouTube link.");
    return;
  }

  let countdown = 45;
  playBtn.disabled = true;
  playBtn.style.backgroundColor = "goldenrod"; // golden yellow when disabled
  playBtn.style.color = "white"; 

  playBtn.innerText = `Song is loading (${countdown})`;

  let timer = setInterval(() => {
    countdown--;
    playBtn.innerText = `Song is loading (${countdown})`;

    if (countdown <= 0) {
      clearInterval(timer);
      playBtn.innerText = "Play for All";
      playBtn.disabled = false;
      playBtn.style.backgroundColor = "#07b686"; // back to green when enabled
    }
  }, 1000);

  isSyncing = true;
  audio.src = url;

  audio.play().catch(() => {});

  setTimeout(() => { isSyncing = false; }, 300);

  socket.emit("play", { room: room, url: url });

  // Wait for actual playback before resetting
  audio.onplaying = () => {
    clearInterval(timer);
    playBtn.innerText = "Play for All";
    playBtn.disabled = false;
    playBtn.style.backgroundColor = "#07b686"; // back to green when playing starts
  };
};
  // ---- Leave button ----
  document.getElementById("leaveBtn").onclick = () => {
    socket.emit("leave", { room: room, name: name });
    window.location.href = "/";
  };

  // Helper to safely apply server state without loops
  function applyState(state) {
    if (!state || !state.url) return;
    isSyncing = true;
    audio.src = state.url;
    audio.currentTime = state.position || 0;

    if (state.is_playing && !justJoined) {
      audio.play().catch(() => {});
    } else {
      audio.pause();
    }

    // Give browser time to settle before re-enabling events
    setTimeout(() => { isSyncing = false; }, 300);
  }

  // ---- Server â†’ Client ----
  socket.on("sync_state", applyState);
  socket.on("current_state", applyState);

  socket.on("play_audio", (data) => {
    isSyncing = true;
    audio.src = data.url;
    audio.play().catch(() => {});
    setTimeout(() => { isSyncing = false; }, 300);
  });

  socket.on("pause_from_server", (data) => {
    isSyncing = true;
    audio.currentTime = data.time;
    audio.pause();
    setTimeout(() => { isSyncing = false; }, 300);
  });

  socket.on("resume_from_server", (data) => {
    isSyncing = true;
    audio.currentTime = data.time;
    audio.play().catch(() => {});
    setTimeout(() => { isSyncing = false; }, 300);
  });

  socket.on("seek_from_server", (data) => {
    isSyncing = true;
    audio.currentTime = data.time;
    if (data.is_playing) {
      audio.play().catch(() => {});
    } else {
      audio.pause();
    }
    setTimeout(() => { isSyncing = false; }, 300);
  });

  // ---- Client â†’ Server (only if not syncing) ----
  audio.onpause = () => {
    if (!isSyncing && !justJoined) {
      socket.emit("pause", { room: room, time: audio.currentTime });
    }
  };

  audio.onplay = () => {
    if (!isSyncing && !justJoined) {
      socket.emit("resume", { room: room, time: audio.currentTime });
    }
  };

  audio.onseeked = () => {
    if (!isSyncing) {
      socket.emit("seek", { room: room, time: audio.currentTime });
    }
  };

  // ---- Periodic time sync ----
  setInterval(() => {
    if (!audio.paused && !isSyncing) {
      socket.emit("time_update", { room: room, time: audio.currentTime });
    }
  }, 1000);

  // ---- Users ----
  socket.on("joined", (data) => {
    const msg =
      data.type === "rejoined"
        ? `${data.name} rejoined`
        : `${data.name} joined`;
    showAlert(msg, "join");
    updateUsers(data.users);
  });

  socket.on("left", (data) => {
   showAlert(`${data.name} left`, "left");
    updateUsers(data.users);
  });

  socket.on("users", (data) => {
    updateUsers(data);
  });

  function updateUsers(users) {
    let ul = document.getElementById("users");
    ul.innerHTML = "";
    users.forEach((u) => (ul.innerHTML += `<li>${u}</li>`));
  }

  function showAlert(msg, type = "join") {
  const container = document.getElementById("fixed-alert");
  const alert = document.createElement("div");
  alert.classList.add("alert");
  alert.innerText = msg;

 if (type === "join") {
  alert.style.background = "rgba(25, 135, 84, 0.95)"; // darker green, more visible
} else if (type === "left") {
  alert.style.background = "rgba(200, 35, 50, 0.95)"; // darker red, more visible
}


  // Apply animation: slide in and then slide out
  alert.style.animation = "slideInLeft 0.5s forwards, slideOutRight 0.5s 3s forwards";

  container.appendChild(alert);

  // Remove element after total animation time (in ms)
  setTimeout(() => {
    alert.remove();
  }, 3500); // 0.5s + 3s
}

</script>



  </body>
</html>
